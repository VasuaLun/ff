create or replace procedure DV_DINAMIC_TESTPROC
(
    pFILE        out BLOB,
    pJURPERS     number,
    pVERSION     number
)
as
  bPrint       boolean := false;
  nCOUNTIN     integer;
  --Объявление коллекции
  --Коллекция с кратким наименованием
  TYPE t_tab1 IS RECORD(
     RN number,
     CODE varchar2(100),
     PRN number
  );
  TYPE t_tab_arr1 IS TABLE OF t_tab1;
  regcode t_tab_arr1;

 --Коллекция с типами
 TYPE t_tab2 IS RECORD(
  RN number,
  CODE varchar2(100)
);
TYPE t_tab_arr2 IS TABLE OF t_tab2;
typecode t_tab_arr2;

begin
begin
    APKG_XLSREP.OPEN_REPORT(nTYPE => 1);
    begin  -- styles
        ----------------------------------------------Начало стилей--------------------------------
        APKG_XLSREP.ADD_STYLE(sSTYLE              => 'title',
                              sHALIGNMENT         => 'Center',
                              nFONTSIZE           => 12,
                              nFONTBOLD           => 1,
                              nWRAPTEXT           => 1);

        APKG_XLSREP.ADD_STYLE(sSTYLE              => 'table_head',
                              sHALIGNMENT         => 'Center',
                              nBORDERTOPWEIGHT    => 1,
                              nBORDERBOTTOMWEIGHT => 1,
                              nBORDERLEFTWEIGHT   => 1,
                              nBORDERRIGHTWEIGHT  => 1,
                              nWRAPTEXT           => 1,
                              sBACKCOLOR          => '#cfdef0',
                              sFONTCOLOR          => '#1d1d1d',
                              sPATTERN            => 'Solid');

        APKG_XLSREP.ADD_STYLE(sSTYLE              => 'border_center_str',
                              nWRAPTEXT           => 1,
                              nBORDERTOPWEIGHT    => 1,
                              nBORDERBOTTOMWEIGHT => 1,
                              nBORDERLEFTWEIGHT   => 1,
                              nBORDERRIGHTWEIGHT  => 1,
                              sHALIGNMENT         => 'Center');

        APKG_XLSREP.ADD_STYLE(sSTYLE              => 'border_left_str',
                              nWRAPTEXT           => 1,
                              nBORDERTOPWEIGHT    => 1,
                              nBORDERBOTTOMWEIGHT => 1,
                              nBORDERLEFTWEIGHT   => 1,
                              nBORDERRIGHTWEIGHT  => 1,
                              sBACKCOLOR          => '#cff0d2',
                              sFONTCOLOR          => '#1d1d1d',
                              sHALIGNMENT         => 'Left');

        APKG_XLSREP.ADD_STYLE(sSTYLE              => 'border_right_num',
                              sHALIGNMENT         => 'Right',
                              nWRAPTEXT           => 1,
                              nBORDERBOTTOMWEIGHT => 1,
                              nBORDERLEFTWEIGHT   => 1,
                              nBORDERRIGHTWEIGHT  => 1,
                              sNUMBERFORMAT       => '#,##0',
                              sINDENT             => 1);

        ----------------------------------------------Конец стилей--------------------------------
    end;   -- end styles

    begin  -- body

        APKG_XLSREP.OPEN_SHEET(nPROTECTED => 0);
        APKG_XLSREP.ADD_RUNTITLE( sHEADERRIGTH => '&amp;L&amp;&quot;Verdana,Полужирный&quot;&amp;K000000&amp;R&amp;&quot;Verdana,Полужирный&quot;&amp;K00-014Подготовлено в ЭС РАМЗЭС');
        APKG_XLSREP.OPEN_TABLE();

        -- Заполнение первой коллекции
        select RN, CODE, PRN BULK COLLECT
        into regcode
        from Z_ORGREG
        where JUR_PERS = pJURPERS and VERSION = pVERSION
        order by CODE;

        --Заполнение второй коллекции с типами
        SELECT RN, CODE BULK COLLECT
        INTO typecode
        FROM Z_ORGROUP
        where JUR_PERS = pJURPERS and VERSION = pVERSION
        ORDER BY CODE;

        APKG_XLSREP.ADD_COLUMN(nWIDTH => 100, nCOUNT => nCOUNTIN);
        APKG_XLSREP.ADD_ROW(nHEIGHT => 20);
        APKG_XLSREP.ADD_CELL(sSTYLE => 'title', sCELLDATA => 'ID Учреждения', sCELLTYPE => 'String');

        for I in regcode.FIRST..regcode.LAST
        loop
            APKG_XLSREP.ADD_CELL(sSTYLE => 'table_head', sCELLDATA => regcode(I).CODE, sCELLTYPE => 'String');
            bPrint := true;
        end loop;

        for I IN typecode.FIRST..typecode.LAST
        loop
            APKG_XLSREP.ADD_ROW(nHEIGHT => 30);
            APKG_XLSREP.ADD_CELL(sSTYLE => 'border_left_str', sCELLDATA => typecode(I).CODE, sCELLTYPE => 'String');
            bPrint := true;
            for A IN regcode.FIRST..regcode.COUNT
            loop
                if (typecode(I).RN = regcode(A).PRN) then
                    APKG_XLSREP.ADD_CELL(sSTYLE => 'border_center_str', sCELLDATA => '1', sCELLTYPE => 'String');
                else
                    APKG_XLSREP.ADD_CELL(sSTYLE => 'border_center_str', sCELLDATA => '0', sCELLTYPE => 'String');
                end if;
            end loop;
        end loop;

        end;   -- end body

        APKG_XLSREP.FLUSH_ROWCELLS();

        APKG_XLSREP.CLOSE_TABLE_AND_SHEET;
        APKG_XLSREP.CLOSE_REPORT();
        pFILE := APKG_XLSREP.GET_BLOB;

    exception when others then
        APKG_XLSREP.CLOSE_REPORT();
        APKG_XLSREP.FREE_BLOB;
       raise;
    end;
    if not bPRINT then
        zp_exception(0,'Формирование пустого отчёта невозможно!');
    end if;
end;
