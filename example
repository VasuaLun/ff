-- Вставить несколько строк в таблицу
insert all
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('ВайфайКул',    1 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('СпецВайфай',   1 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('ТонронМост',   1 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Тонрон',       1 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Роновкор',     2 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Ронов',        2 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Торонпит',     2 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Торон',        2 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Жизньком',     2 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Соцсетикрона', 2 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('КаналЛинк',    3 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Поисковиким',  3 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Сообщениямия', 3 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Риот',         3 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Алетта',       4 , 1)
    into DV_ORGREG (NAME, CITY_ID, VERSION) values ('Мелания',      4 , 1)
SELECT * FROM dual;

-- Заполнить все NULL значения определенным
update DV_ORGREG
    set VERSION = 1
where VERSION is NULL

-- Изменения значения ячеек в таблице
update DV_ORGREG
    set ADDRESS = 'Moscow, Lenina'
    where ID = 1;

-- Удаление столбца из таблицы

ALTER TABLE DV_SERVREG DROP COLUMN SERV_NAME;
-- Добавление столбца в таблицу
ALTER TABLE DV_SERVREG
ADD SERV_NAME VARCHAR(50) NULL;

-- Создание sequence
create sequence dv_test_sequence
start with 1
increment by 1;
------------------------------------------------------------------------

-- Заполнение таблицы услуг
insert all
SELECT * FROM dual;
into DV_SERVREG (SERV_NAME) values ('широкополосный доступ в Интернет')
into DV_SERVREG (SERV_NAME) values ('беспроводной доступ в Интернет')
into DV_SERVREG (SERV_NAME) values ('выделение дискового пространства для хранения и обеспечения работы сайтов')
into DV_SERVREG (SERV_NAME) values ('поддержка электронных почтовых ящиков или виртуального почтового сервера')
into DV_SERVREG (SERV_NAME) values ('размещение оборудования клиента на площадке провайдера')
into DV_SERVREG (SERV_NAME) values ('аренда выделенных и виртуальных серверов (VPS, VDS)')
into DV_SERVREG (SERV_NAME) values ('резервирование данных')
into DV_SERVREG (SERV_NAME) values ('аренда сетевого оборудования')

-- Заполнение словаря-списка
insert all
    into DV_CITYDICTIONARY (ID, CITY_NAME) values (1, 'Москва')
    into DV_CITYDICTIONARY (ID, CITY_NAME) values (2, 'Санкт-Петербург')
    into DV_CITYDICTIONARY (ID, CITY_NAME) values (3, 'Самара')
    into DV_CITYDICTIONARY (ID, CITY_NAME) values (4, 'Новосибирск')
    into DV_CITYDICTIONARY (ID, CITY_NAME) values (5, 'Ростов')
SELECT * FROM dual;

-- Заполнение таблицы сопоставления услуг и организаций
insert all
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 1)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 2)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 3)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 4)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 5)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 6)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 7)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 8)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 9)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (1, 10)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (2, 2)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (2, 3)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (2, 6)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (2, 7)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (2, 10)
    into DV_SERVLINKS (ORG_ID, SERV_ID) values (3, 7)
SELECT * FROM dual;

-- Двухуровненвый Join для связи компаний и предоставляемых ими услуг
select org.NAME as orgname, serv.SERV_NAME as servname
from DV_ORGREG org
inner join DV_SERVLINKS link on org.ID = link.ORG_ID
inner join DV_SERVREG serv on link.SERV_ID = serv.ID;

select "ROWID",
"ORG_ID",
"SERV_ID"
from "#OWNER#"."DV_SERVLINKS"


-- Отображение таблицы на странице Учреждения VER 0 (без услуг)
select DV_ORGREG.NAME as NAME,
    DV_CITYDICTIONARY.CITY_NAME as CITY_NAME
 from DV_ORGREG DV_ORGREG,
    DV_CITYDICTIONARY DV_CITYDICTIONARY
 where DV_CITYDICTIONARY.ID=DV_ORGREG.CITY_ID

 -- Отображение таблицы на странице Учреждения VER 1 (с количеством услуг)
select DV_ORGREG.NAME as NAME,
     DV_CITYDICTIONARY.CITY_NAME as CITY_NAME,
     (select COUNT(*) as SERV_COUNT
     from DV_ORGREG DV_ORGREG,
        DV_SERVLINKS DV_SERVLINKS
     where DV_ORGREG.ID = DV_SERVLINKS.ORG_ID
     group by DV_SERVLINKS.ORG_ID)
  from DV_ORGREG DV_ORGREG,
     DV_CITYDICTIONARY DV_CITYDICTIONARY
  where DV_CITYDICTIONARY.ID=DV_ORGREG.CITY_ID

select COUNT(*) as SERV_COUNT
  from DV_ORGREG DV_ORGREG,
     DV_SERVLINKS DV_SERVLINKS
  where DV_ORGREG.ID = DV_SERVLINKS.ORG_ID
  group by DV_SERVLINKS.ORG_ID

select DV_ORGREG.NAME as NAME,
     DV_CITYDICTIONARY.CITY_NAME as CITY_NAME,
     COUNT(DV_SERVLINKS.SERV_ID) as SERV_COUNT
    from DV_ORGREG DV_ORGREG, DV_SERVLINKS DV_SERVLINKS
    left join DV_SERVLINKS DV_SERVLINKS
    on DV_SERVLINKS.ORG_ID = DV_ORGREG.ID
    where DV_ORGREG.ID = DV_SERVLINKS.ORG_ID and
    DV_ORGREG.ID = DV_SERVLINKS.ORG_ID
    group by DV_SERVLINKS.ORG_ID


    select serv.SERV_NAME as display_value, serv.ID as return_value
    from DV_SERVREG serv
    inner join DV_SERVLINKS link on link.SERV_ID = serv.ID
    inner join DV_ORGREG org on link.ORG_ID = org.ID
    where link.ORG_ID = :P22_ID_ORG;

-- Услуги по датам Ver 1
select org.NAME, servejourn.SERV_DATE,
COUNT(servejourn.ID_SERV) as SERV_COUNT
    from DV_ORGREG org,
        DV_SERVJOURNAL servejourn
    where org.ID = servejourn.ID_ORG
    group by servejourn.SERV_DATE, org.NAME
    order by servejourn.SERV_DATE

-- Услуги по датам Ver 2
select org.NAME, servejourn.SERV_DATE,
COUNT(servejourn.ID_SERV) as SERV_COUNT,
SUM()
    from DV_ORGREG org,
        DV_SERVJOURNAL servejourn
    where org.ID = servejourn.ID_ORG
    group by servejourn.SERV_DATE, org.NAME
    order by servejourn.SERV_DATE

-- История совершения услуг Ver 1
select DV_ORGREG.NAME as NAME,
    DV_SERVREG.SERV_NAME as SERV_NAME,
    DV_SERVLINKS.SEVRE_PRICE as SEVRE_PRICE,
    DV_SERVJOURNAL.SERV_DATE as SERV_DATE
 from DV_ORGREG DV_ORGREG,
    DV_SERVJOURNAL DV_SERVJOURNAL,
    DV_SERVREG DV_SERVREG,
    DV_SERVLINKS DV_SERVLINKS
 where DV_SERVJOURNAL.ID_ORG=DV_ORGREG.ID
    and DV_SERVJOURNAL.ID_SERV=DV_SERVREG.ID
    and DV_SERVLINKS.SERV_ID=DV_SERVREG.ID
 order by DV_SERVJOURNAL.SERV_DATE ASC, DV_ORGREG.NAME ASC, DV_SERVREG.SERV_NAME ASC

 -- История совершения услуг Ver2
 select DV_ORGREG.NAME as NAME,
     DV_SERVREG.SERV_NAME as SERV_NAME,
     DV_SERVLINKS.SEVRE_PRICE as SEVRE_PRICE,
     DV_SERVJOURNAL.SERV_DATE as SERV_DATE
  from DV_ORGREG DV_ORGREG,
     DV_SERVLINKS DV_SERVLINKS,
     DV_SERVREG DV_SERVREG,
     DV_SERVJOURNAL DV_SERVJOURNAL
  where DV_SERVJOURNAL.ID_ORG=DV_ORGREG.ID
     and DV_SERVJOURNAL.ID_SERV=DV_SERVREG.ID
     and DV_SERVREG.ID=DV_SERVLINKS.SERV_ID
     and DV_ORGREG.ID=DV_SERVLINKS.ORG_ID
  order by DV_SERVJOURNAL.SERV_DATE ASC, DV_ORGREG.NAME ASC, DV_SERVREG.SERV_NAME ASC

  -- Услуги компаний отображение
  select DV_ORGREG.NAME as NAME,
    DV_SERVREG.SERV_NAME as SERV_NAME,
    DV_SERVLINKS.SEVRE_PRICE as SEVRE_PRICE
 from DV_SERVREG DV_SERVREG,
    DV_ORGREG DV_ORGREG,
    DV_SERVLINKS DV_SERVLINKS
 where DV_ORGREG.ID=DV_SERVLINKS.ORG_ID
    and DV_SERVLINKS.SERV_ID=DV_SERVREG.ID
 order by DV_ORGREG.NAME ASC, DV_SERVREG.SERV_NAME ASC

 select o.ROWID, o.NAME as NAME,
     t.CITY_NAME as CITY_NAME
  from DV_ORGREG o,
     DV_CITYDICTIONARY t
  where (t.ID=o.CITY_ID(+) and o.CITY_ID = :P16_CITY and
 UPPER(o.NAME) like UPPER('%'||:P16_SEARCH||'%')) or
 (t.ID=o.CITY_ID(+) and :P16_CITY is NULL and
 UPPER(o.NAME) like UPPER('%'||:P16_SEARCH||'%'))

 -- Исправленное отображение для Статистики (с учетом версий)
 select j.ROWID, o.NAME as NAME,
     s.SERV_NAME as SERV_NAME,
     L.SEVRE_PRICE as SEVRE_PRICE,
     j.SERV_DATE as SERV_DATE
  from DV_ORGREG o,
     DV_SERVLINKS L,
     DV_SERVREG s,
     DV_SERVJOURNAL j
  where j.ID_ORG=o.A_ID
     and j.ID_SERV=s.A_SERVEID
     and s.ID=L.SERV_ID
     and o.ID=L.ORG_ID
     and j.VERSION = :P1_VERSION
  order by j.SERV_DATE ASC, o.NAME ASC, s.SERV_NAME ASC

  begin
  htp.p('<table border = "1" class="uReport uReportStandard">');
    for rec in
    (
  select ROWID, ID,
  SERV_NAME
  from DV_SERVREG where VERSION = :P1_VERSION
    )LOOP

      htp.p('<tr>');
          htp.p('<td style="background-color: yellow">'||'<a href="f?p=103:19:'||v('APP_SESSION')||'::NO::P19_ID:'||rec.ID||'">Edit</a></td>');
          htp.p('<td><div style="color:red"><b>'||rec.SERV_NAME||'</b></div></td>');
      htp.p('</tr>');
    END LOOP;
   htp.p('</table>');
  end;
