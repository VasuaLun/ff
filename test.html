--101; 584; Z_SERVREG
declare
 pJURPERS      number          := :P1_JURPERS;
 pVERSION      number          := :P1_VERSION;
 pORGRN	       number          := nvl(:P1_ORGRN,:P7_ORGFILTER);

 pUSER         varchar2(100)   := :APP_USER;
 pROLE         number          := ZGET_ROLE;

 pSEARCH       varchar2(4000)  := :P584_SEARCH;
 pWORKSERV     number          := :P584_WORKSERV;
 pSERVTYPE     number          := :P584_SERVTYPE2;
 pSERVSIGN     number          := :P584_SERVSIGN;
 -----------------------------------------------
 sREGNUM       varchar2(4000);
 sUNIQREGNUM   varchar2(4000);
 sSERVCODE     varchar2(4000);
 sWORKSERV     varchar2(4000);
 sSERVTYPE     varchar2(4000);
 sMEASURE      varchar2(4000);
 sQINDVAL      varchar2(4000);
 sORGCOUNT     varchar2(4000);
 -----------------------------------------------
 nCOUNTROWS    number;
 nTOTALSUM     number;
 nKINDQIND     number;
 nVALQIND      number;
 nSTATQIND     number;
 nPREVWORKSERV number;

 sColor        varchar2(100);
 sCOLORROW     varchar2(100);
 sMSG	       varchar2(250);

begin
    -- Права доступа
    ----------------------------------------------------
    ----------------------------------------------------

    apex_javascript.add_library (
    p_name                  => 'jquery.inputmask.bundle',
    p_directory             => '/i/');

    htp.p(
    '<style>
        ::-webkit-scrollbar {
          width: 17px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
          -webkit-box-shadow: inset 0 0 12px rgba(0,0,0,0.3);
          -webkit-border-radius: 12px;
          border-radius: 12px;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
          -webkit-border-radius: 10px;
          border-radius: 12px; border-left: 2px solid #eee; border-right: 2px solid #eee;
          background: #dbe8f8;
          -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5);

        }
        ::-webkit-scrollbar-thumb:window-inactive {
          background: rgba(255,0,0,0.4);
        }
         .report_standard tbody tr:hover td {
             background-color: #dbe8f8 !important; color: #000;
                  cursor: pointer; font-weight:bolder;
            }
        .report_standard  thead > tr {width: 100%; }
        .report_standard  tbody > tr {width: 100%; display: block}
        .report_standard > tbody {
        display: block; height: 300px; overflow-x: hidden;  overflow-y: scroll;
          }

        .sub_td {padding:0;margin:0; border:none;}

        .sub_region {
          width:100%;
        }
        .sub_region  {

        }

        .report_standard thead {
          display: block; width:100%
        }
        .report_standard{
          border: 1px solid grey;
        }

        .report_standard th, td{
          text-align:left;
          vertical-align: middle;
        }
        .report_standard th{
          text-align:center;
          line-height: 1.5em;
          vertical-align: middle;
        }
        .report_standard th {
          color:#222;
          font: bold 12px "Helvetica Neue",Helvetica,Arial,sans-serif;
          text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
          padding: 5px 4px;
           /* background: url(/i/themes/theme_17/images/sReportBG-Aqua.png) 0 50% #e1e1e1 repeat-x;*/
          background: #e0e0e0;
          border-bottom: 1px solid #9fa0a0;
          border-left:1px solid #9fa0a0;
        }
        .report_standard td{
          padding: 5px 4px;
          border-bottom: 1px solid #9fa0a0;
          border-left:1px solid #9fa0a0;
          background-color: #f2f2f2;
        }

        .link_code {text-decoration: underline;font-weight: bold; color:#0000ff;}
        .row { margin-bottom: 5px;}

		.th1{width: 50px;text-align:center; border-left: 0px !important}  .c1 {width: 50px; word-wrap: break-word; text-align:center; border-left: 0px !important}
        .th2{width: 90px;text-align:center;}   .c2 {width: 90px; word-wrap: break-word; text-align:center;}
        .th3{width: 200px;text-align:center;}  .c3 {width: 200px; word-wrap: break-word; text-align:center;}
        .th4{width: 100%;text-align:center;}   .c4 {width: 100%; word-wrap: break-word; text-align:left;}
        .th5{width: 180px;text-align:center;}  .c5 {width: 180px; word-wrap: break-word; text-align:center;}
        .th6{width: 100px;text-align:center;}  .c6 {width: 100px; word-wrap: break-word; text-align:center;}
        .th7{width: 80px;text-align:center;}   .c7 {width: 80px; word-wrap: break-word; text-align:center;}
        .th8{width: 50px;text-align:center;}   .c8 {width: 50px; word-wrap: break-word; text-align:center;}

        .pagination {text-align: right;
          border-left: 1px solid grey;
          border-right: 1px solid grey;
          border-bottom: 1px solid grey;
          margin: 0px;

          padding: 5px;
          background: url(/i/themes/theme_17/images/sReportBG-Aqua.png) 0 100% #e1e1e1 repeat-x;cursor:move;
        }
        .pagination li {display: inline; margin-left:5px; font-size: 12px; padding: 2px; cursor:default; }
        .selected_row{padding: 4px 4px;
          border-bottom: 1px solid #9fa0a0;
          background-color: #FAFF82;
        }
    </style>');

    htp.p('<div id="tablediv"><table border="0" cellpadding="0" cellspacing="0" class="report_standard" style="width:100%;">
    <thead>
        <tr>
         <th class="header th1"><div class="th4">Признак</div></th>

         <th class="header th2"><div class="th2">Код</div></th>
         <th class="header th3"><div class="th3">УНРЗ</div></th>
         <th class="header th4"><div class="th4">Наименовение</div></th>

		 <th class="header th5"><div class="th5">Тип</div></th>
         <th class="header th6"><div class="th6">Ед.изм</div></th>
		 <th class="header th7"><div class="th7">Показатели О/К/С</div></th>
		 <th class="header th8"><div class="th8">Учр</div></th>
		 <th class="header"><div style="width:8px"></div></th>
        </tr>

      </thead>
    <tbody id="fullall" >');


    for rec in
    (
     select S.RN SERVRN,
	        S.REGNUM,
			nvl(UNIQREGNUM_FULL, UNIQREGNUM) UNIQREGNUM,
			S.CODE SERVCODE,
            L1.NUM WORKSERVNUM,
			L1.NOTE WORKSERVNAME,
			ST2.NAME SERVTYPE,
            D.CODE   MEASURE,
			(select COUNT (*) from Z_SERVLINKS SL where SL.SERVRN = S.RN) ORGCOUNT
	   from Z_SERVREG S, Z_LOV L1, Z_SERVTYPE2 ST2, Z_DICMUNTS D
	  where S.JUR_PERS = pJURPERS
	    and S.VERSION  = pVERSION
	    and S.WORKSERV_SIGN = L1.NUM (+)
	    and L1.PART (+) = 'SERVTYPE'
		and S.SERVTYPE2 = ST2.RN (+)
        and S.MEASURE   = D.RN (+)
		and ((pORGRN is null) or (S.RN in (select SL.SERVRN from Z_SERVLINKS SL where SL.SERVRN = S.RN)))

        and ((pWORKSERV is null) or (S.WORKSERV_SIGN = pWORKSERV))
        and ((pSERVTYPE is null) or (S.SERVTYPE2 = pSERVTYPE))
        and ((pSERVSIGN is null) or (S.SERVSIGN = pSERVSIGN))



        and ((pORGRN is null) or (S.RN in (select SERVRN from Z_SERVLINKS where SERVRN = S.RN and ORGRN = pORGRN)))

	    and (
		    (pSEARCH is null)
		     or
		    (
			    (Upper(S.REGNUM) like '%'||Upper(pSEARCH)||'%')
			 or (Upper(S.CODE) like '%'||Upper(pSEARCH)||'%')
             or (Upper(S.UNIQREGNUM) like '%'||Upper(pSEARCH)||'%')
             or (Upper(S.UNIQREGNUM_FULL) like '%'||Upper(pSEARCH)||'%')

		    )
		    )
      order by S.WORKSERV_SIGN, S.PARENT_SIGN nulls first, S.PRN nulls first, S.ORDERNUMB, lpad(S.REGNUM, 20, ' ')
    )
    loop
        nKINDQIND := null;
        nVALQIND  := null;
        nSTATQIND := null;
        for QVAL in
        (
        select Q.QINDSIGN, COUNT(*) QINDCOUNT
         from Z_SERVIND SI,
              Z_QINDLIST Q
        where SI.PRN = rec.SERVRN
          and SI.QIND = Q.RN
        group by Q.QINDSIGN
        )
        loop
            if QVAL.QINDSIGN = 1 then
                nKINDQIND := QVAL.QINDCOUNT;
            elsif QVAL.QINDSIGN = 2 then
                nVALQIND := QVAL.QINDCOUNT;
            elsif QVAL.QINDSIGN = 4 then
                nSTATQIND := QVAL.QINDCOUNT;
            end if;
        end loop;

        if (nPREVWORKSERV <> rec.WORKSERVNUM) or (nPREVWORKSERV is null) then
            sWORKSERV    := '<td class="c1 workserv"><div class="c1"></></div></td>';

            sREGNUM      := '<td class="c2 workserv"><div class="c2"></></div></td>';
    		sUNIQREGNUM  := '<td class="c3 workserv"><div class="c3">'|| rec.WORKSERVNAME ||'</></div></td>';
    		sSERVCODE    := '<td class="c4 workserv"><div class="c4"></div></td>';


            sSERVTYPE    := '<td class="c5 workserv"><div class="c5"></></div></td>';
    		sMEASURE    := '<td class="c6 workserv"><div class="c6"></></div></td>';

    		sQINDVAL     := '<td class="c7 workserv"><div class="c7"></div></td>';
    		sORGCOUNT    := '<td class="c8 workserv"><div class="c8"></div></td>';

            htp.p('
                <tr id="row_'||rec.SERVRN||'" row="'||rec.SERVRN||'">
                    '||sWORKSERV||'

                    '||sREGNUM||'
                    '||sUNIQREGNUM||'
                    '||sSERVCODE||'

                    '||sSERVTYPE||'
                    '||sMEASURE||'

					'||sQINDVAL||'
					'||sORGCOUNT||'

                </tr>');
            nPREVWORKSERV := rec.WORKSERVNUM;
        end if;

        sWORKSERV    := '<td class="c1"><div class="c1">'||substr(rec.WORKSERVNAME,1,1)||'</></div></td>';

        sREGNUM      := '<td class="c2"><div class="c2">'||rec.REGNUM||'</></div></td>';
		sUNIQREGNUM  := '<td class="c3"><div class="c3">'||rec.UNIQREGNUM||'</></div></td>';
		sSERVCODE    := '<td class="c4"><div class="c4"><a href="'||APEX_UTIL.PREPARE_URL('f?p='||:APP_ID||':5:'||:APP_SESSION||'::::P5_RN,P584_SELECTED_ROW:'||rec.SERVRN || ','|| rec.SERVRN)||'" class = "link_code">'||rec.SERVCODE||'</a></div></td>';

        sSERVTYPE    := '<td class="c5"><div class="c5">'||rec.SERVTYPE||'</></div></td>';
		sMEASURE    := '<td class="c6"><div class="c6">'||rec.MEASURE||'</></div></td>';

		sQINDVAL     := '<td class="c7 qind"><div class="c7">'|| case when nvl(nVALQIND,0) > 0  then '<span style="font-weight: bold;color:green">'||nvl(nVALQIND,0)||'</span>' else '<span style="font-weight: bold;color:red">'||nvl(nVALQIND,0)||'</span>' end || ' / '||
                                                                 case when nvl(nKINDQIND,0) > 0  then '<span style="font-weight: bold;color:green">'||nvl(nKINDQIND,0)||'</span>' else '<span style="font-weight: bold;color:red">'||nvl(nKINDQIND,0)||'</span>' end || ' / '||
                                                                 case when nvl(nSTATQIND,0) > 0  then '<span style="font-weight: bold;color:green">'||nvl(nSTATQIND,0)||'</span>' else '<span style="font-weight: bold;color:red">'||nvl(nSTATQIND,0)||'</span>' end ||
                                                                 '</></div></td>';

		sORGCOUNT    := '<td class="c8"><div class="c8"><a href="'||APEX_UTIL.PREPARE_URL('f?p='||:APP_ID||':45:'||:APP_SESSION||'::::P45_SERVRN,P584_SELECTED_ROW:'||rec.SERVRN) || ','|| rec.SERVRN||'" class = "link_code">'||rec.ORGCOUNT||'</a></div></td>';

		if nvl(nCOUNTROWS,0) <= 500 then
            htp.p('
                <tr id="row_'||rec.SERVRN||'" row="'||rec.SERVRN||'">
                    '||sWORKSERV||'

                    '||sREGNUM||'
                    '||sUNIQREGNUM||'
                    '||sSERVCODE||'


                    '||sSERVTYPE||'
                    '||sMEASURE||'

					'||sQINDVAL||'
					'||sORGCOUNT||'

                </tr>');
			nCOUNTROWS := nvl(nCOUNTROWS,0) + 1;
        else
            EXIT;
        end if;

    end loop;

    if nvl(nCOUNTROWS,0) > 500 then
		sColor := 'font-weight:regular;color:red';
		sMSG := 'Выбрано слишком много записей. Отображены первые 500. Необходимо использовать фильтры.';
	else
		sColor := '';
		sMSG := 'Всего записей: <b>'||nCOUNTROWS;
	end if;

    htp.p('</tbody></table></div>');
    htp.p('<ul class="pagination" style="margin:0px">');
    htp.p('<li style="float:right;'||sColor||'">'||sMSG||'</b></li>');
    htp.p('<li style="float:left; display: none;" id="loading_scroll"><img src="/i/378.GIF" style="width: 130px"/> </li>');
    htp.p('<li style="float:left; " id="save_shtat"></li>');
    htp.p('<li style="clear:both"></li></ul>');
    htp.p(
    '<script>

        $(function(){
          table_body=$("#fullall");


          if (window.screen.height<=1024) {
          table_body.height("260px");
          $(".report_standard").css("width","100%");
          } else {
          table_body.height("700px");
          $(".report_standard").css("width","100%");
          }
            $(".pagination").mousedown(startDrag);


            function startDrag(e){
                staticOffset = table_body.height() - e.pageY;
                table_body.css("opacity", 0.25);
                $(document).mousemove(performDrag).mouseup(endDrag);
                return false;
              }

              function performDrag(e){
                table_body.height(Math.max(150, staticOffset + e.pageY) + "px");
                return false;
              }

              function endDrag(e){
                $(document).unbind("mousemove", performDrag).unbind("mouseup", endDrag);
                table_body.css("opacity", 1);
              }
        });

        var el = document.getElementById("row_"+$v("P584_SELECTED_ROW"));
		if (el!==null){
		 el.scrollIntoView(true);
		  $(el).children().css("background-color","yellow");
		}

    </script>');
end;
